---
title: "High Dimensional Data Analysis - Group Assignment"
author: "Group 18"
date: "08/09/2021"
output: bookdown::pdf_document2
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(visdat)
library(splitstackshape)
library(lubridate)
library(mclust)
```

#```{r Data}
#data <- readRDS(here::here("data/Bankruptcy.rds"))
#glimpse(data)
#summary(data)
#vis_dat(data)
#vis_miss(data)
#```

#```{r MissingData}
#Data <- data %>% na.omit()
#mean_EmplUnion <- mean(Data$EmplUnion)
#mean_Ebit <- mean(Data$Ebit)
#mean_Liab <- mean(Data$Liab)
#mean_DaysIn <- mean(Data$DaysIn)
#mean_HeadCourtCityToDE <- mean(Data$HeadCourtCityToDE)

#data$EmplUnion <- data %>% pull(EmplUnion) %>% replace_na(mean_EmplUnion)
#data$Ebit <- data %>% pull(Ebit) %>% replace_na(mean_Ebit)
#data$Liab <- data %>% pull(Liab) %>% replace_na(mean_Liab)
#data$DaysIn <- data %>% pull(DaysIn) %>% replace_na(mean_DaysIn)
#data$HeadCourtCityToDE <- data %>% pull(HeadCourtCityToDE) %>% #replace_na(mean_HeadCourtCityToDE)
#Bankruptcy <- data %>% na.omit()

#glimpse(Bankruptcy)
#summary(Bankruptcy)
#vis_miss(Bankruptcy)
#vis_dat(Bankruptcy)
#```

```{r}
data <- read_rds(here::here("data/Bankruptcy.rds"))
```

```{r}
glimpse(data)
```

```{r}
vis_dat(data)
```
Note:
We can see that FirmEnd does not have any missing values, in fact it has many NULL values that is not detected. Hence, we will change it to NA. 

```{r}
data <- data %>%
  mutate(FirmEnd = ifelse(FirmEnd == "", NA, FirmEnd))
```

From the `glimpse` output, we also notice that `SICMajGroup`, which is the industry classificatin code, has a very long name, so we will separate it to the code and the meaning. 

```{r}
data <- data %>%
  separate(SICMajGroup, into = c("SIC", "SICMajGroup"), sep = "\\s", extra = "merge") %>%
  mutate(SIC = as.factor(SIC))
```


Now, let us check again the missing values in data 

```{r}
vis_dat(data)
```

**HeadCourtCityToDE**

There are some missing values in `HeadCourtCityToDE`, may be we could impute it using the values in CityFiled, DENYOther, or HeadStAtFiling. One of the row missing is Aruba, so we just google the distance between these cities an impute it (1126 miles). The other two are Canada. We search the address for the firm name and google the distance. 
Loewen Group, Inc (British Columbia to Wilmington = 2942).
Philip Services Corp. (Ontario to Wilmington = 1234)


```{r}
na_distance <- data %>%
  filter(is.na(HeadCourtCityToDE))

data <- data %>%
  mutate(HeadCourtCityToDE = ifelse(Name == "Divi Hotels, N.V.", 1126,
                                    ifelse(Name == "Loewen Group, Inc.", 2942,
                                           ifelse(Name == "Philip Services Corp. (1999)", 1234,
                                                  HeadCourtCityToDE))))

summary(data$HeadCourtCityToDE)
```
The minimun distance is 1 , when inspected the state of headquarter and the city filed its in the same state, so it made sense.



**DaysIn**

Now let us move to `DaysIn` variable 

```{r}
na_daysin <- filter(data, is.na(DaysIn))
```

Based on google search:
- [AP Industries, Inc.](https://casetext.com/case/in-re-ap-industries-inc?__cf_chl_jschl_tk__=pmd_0e9LcvX3fGC0nT5WJVBShbHDvK9GY2AMZnekCjslbN0-1631333530-0-gqNtZGzNAjujcnBszQd9) filed the bankruptcy on 27/03/1990, disposition made in 26/07/1990. -> 121 days

- [Daisy Systems Corp.](https://caselaw.findlaw.com/us-9th-circuit/1020075.html) filed the bankruptcy on 30/05/1991, the court decided on 24/09/1996.  -> 1944 days

- Since there is no data for the remaining two, we will impute the days in bankruptcy, based on firm types median. (Hunt International Resources Corp., SIC = 20; McCrory Corp., SIC = 53)

```{r}
data %>% group_by(SIC) %>%
  summarise(median = median(DaysIn, na.rm = TRUE))
```

```{r}
data <- data %>%
  mutate(DaysIn = ifelse(Name == "Hunt International Resources Corp.", 305,
                                    ifelse(Name == "AP Industries, Inc.", 121,
                                           ifelse(Name == "Daisy Systems Corp.", 1944,
                                                  ifelse(Name == "McCrory Corp.", 683, DaysIn)))))

summary(data$DaysIn)
```

There is no suspicious anomaly. The bankcruptcy process can take a long time. 

**Employees**

```{r}
na_employees <- filter(data, is.na(Employees))
```

The number of employees of County Seat, Inc. is missing. According to [Chicago Tribune](https://www.chicagotribune.com/news/ct-xpm-1996-11-29-9611290135-story.html), the store has an average 5-10 employees and it has 740 stores. We will take 7 employees per store. So the employees before bankruptcy are approximately 5180. 

```{r}
data <- data %>%
  mutate(Employees = ifelse(Name == "County Seat, Inc.", 5180, Employees))

summary(data$Employees)
```

Is it possible that companies only have 1 employees? 

```{r}
ggplot(data, aes(x = Employees)) +
  geom_histogram()
```

```{r}
vis_dat(data)
```

**Sales**

The missing values in Sales is imputed by its median of sales grouped by SIC

```{r}
na_sales <- filter(data, is.na(Sales))

data %>%
  group_by(SIC) %>%
  summarise(median = median(Sales, na.rm = TRUE))

data <- data %>%
  mutate(Sales = ifelse(Name == "County Seat, Inc.", 1645170944, Sales))

```

**Ebit and Liab**

```{r}
na_ebit <- filter(data, is.na(Ebit))
na_liab <- filter(data, is.na(Liab))
```

Options for treat the missing values in `Liab` and `Ebit`:
1. Omit the missing values in these variables

```{r}
data_op1 <- data %>%
  filter(!is.na(Ebit) & !is.na(Liab))

vis_dat(data_op1)
```

#2. Impute with its median grouped by SIC 

#```{r}
#data_op2 <- data %>% group_by(SIC) %>%
#  mutate(Ebit = ifelse(is.na(Ebit), median(Ebit,na.rm=TRUE), Ebit))

#data_op2 <- data_op2 %>% group_by(SIC) %>%
#  mutate(Liab = ifelse(is.na(Liab), median(Liab,na.rm=TRUE), Liab))

#vis_dat(data_op2)
#```

# Clean Data

Let say we use data_op1. 

```{r}
data_clean <- data_op1 %>%
  select(-FirmEnd, -EmplUnion) %>%
  mutate(DENYOther = as.factor(DENYOther),
         MonthFiled = as.factor(MonthFiled),
         YearFiled = as.factor(YearFiled))

row.names(data_clean) <- data_clean$Name

ggplot(data_clean, aes(x = Ebit)) +
  geom_histogram()
```


```{r}
vis_dat(data_clean)
```

```{r}
ggplot(data, aes(x = Employees, y = EmplUnion)) + geom_point() + geom_smooth()
```

## Multidimensional Scaling:

```{r}
# data wo missing values, number obs as in original data 
dd <- data_clean %>% ungroup() %>% select_if(is.numeric) %>%
  scale %>% dist(method = "manhattan")

rownames(data_clean) -> attributes(dd)$Labels

cmds<-cmdscale(dd,eig = T)

cmds$points%>%
as.data.frame()%>%
rownames_to_column(var = 'Names')->df

p1 <- ggplot(df,aes(x=V1,y=V2,label=`Names`))+ geom_text(size=2) # xlim(0, 30) + ylim(-20,20)
p1
```

## Clustering

Clustering is the process of grouping the observations into categories or groups of observations based on their similarities. It helps us identify the commonalities and similar characteristics within the data which help us answer business questions.

In this case, we can validate if there are any similarities among the companies that are going bankrupt. This helps us understand the most possible reason for organisations going bankrupt and possibly help prevent the same in the future.

There are two main types of clustering namely, hierarchical and non-hierarchical clustering. Non hierarchical clustering with the number of clusters known ex ante are useful if the number of clusters can be determined beforehand. We will mainly focus on Hierarchical clustering method.

### Hierarchical Clustering:

```{r}
clust_data <- data_clean %>% 
  ungroup %>% 
  dplyr::filter(Name != "Texaco Inc.") %>% 
  dplyr::select(c(Assets, CPI, DaysIn, Employees, 
                  Ebit, Liab, FilingRate, GDP, 
                  PrimeFiling, Sales)) %>%
  select_if(is.numeric) %>%
  scale %>% dist() %>% hclust(method = "ward.D2")

clust_data %>% plot(cex=.5)
clust_data %>% rect.hclust(k=3)
```

The tolerance values for different number of clusters is as follows:

- Trying diff values of k to get the best cluster value
  + when k = 2 value is around 34
  + when k = 3 value is around 29
  + when k = 4 value is around 23
  + when k = 6 value is around 21
  + when k = 7 value is around 18
  
We can observe that there is a big range of Height tolerance on y-axis for k = 3 with the next values at 34 and and 23 for k = 2 and k = 4 respectively. Thus, we cluster the data into three clusters.  

### Choosing the best method:

```{r}
data_clean %>% ungroup() %>% select_if(is.numeric) %>%
  scale %>% dist() %>% hclust(method = "ward.D2") %>% cutree(k = 10)-> memb_ten_w
data_clean %>% ungroup() %>% select_if(is.numeric) %>%
  scale %>% dist() %>% hclust(method = "average") %>% cutree(k = 10)-> memb_ten_al
data_clean %>% ungroup() %>% select_if(is.numeric) %>%
  scale %>% dist() %>% hclust(method = "centroid") %>% cutree(k = 10)-> memb_ten_cm
data_clean %>% ungroup() %>% select_if(is.numeric) %>%
  scale %>% dist() %>% hclust(method = "complete") %>% cutree(k = 10)-> memb_ten_cl

adjustedRandIndex(memb_ten_w, memb_ten_al)
adjustedRandIndex(memb_ten_w, memb_ten_cm)
adjustedRandIndex(memb_ten_w, memb_ten_cl)
```

The complete linkage method has the highest agreement between the different types of clustering. If all the clustering methods give almost similar results, then we can safely say that the data has some evident observable patterns. If not, the data does not have any solid patterns to cluster it based on similarities. In our case, there is no solid evidence of clustering results from the different methods. Each method gives an almost new result. Thus we can say that from the given data it is hard to find patterns that are making the organizations go bankrupt. The closest method to Ward D2 is Complete Linkage method which is 44% similar to the Ward D2 method.

#```{r}
#data_clean2 <- data_op2 %>%
#  select(-FirmEnd, -EmplUnion) %>%
#  mutate(DENYOther = as.factor(DENYOther),
#         MonthFiled = as.factor(MonthFiled),
#         YearFiled = as.factor(YearFiled)) 
#row.names(data_clean2) <- data_clean2$Name

# data wo missing values, number obs as in original data 
#dd2 <- data_clean2 %>%  ungroup() %>% select_if(is.numeric) %>%
#  scale %>% dist(method = "manhattan")


#rownames(data_clean2) -> attributes(dd2)$Labels

#cmds2<-cmdscale(dd2,eig = T)

#cmds2$points%>%
#as.data.frame()%>%
#rownames_to_column(var = 'Names')->df2

#df2 <- left_join(df2, data_clean2, by = c("Names" = "Name"))

#p2 <- ggplot(df2,aes(x=V1,y=V2,label=`Names`, color = DENYOther))+ geom_text(size=2) # #xlim(0, 30) + ylim(-20,20)

#p2
#```
#```{r}
#library(patchwork)

#p1 + p2 + plot_layout(nrow = 2)
#```

#```{r}
#data <- read_rds(here::here("data/Bankruptcy.rds"))

#data_clean3 <- data %>%
#  select(-FirmEnd, -EmplUnion) %>%
#  drop_na() %>%
#  mutate(DENYOther = as.factor(DENYOther),
#         MonthFiled = as.factor(MonthFiled),
#         YearFiled = as.factor(YearFiled)) 

#row.names(data_clean3) <- data_clean3$Name

# data wo missing values, number obs as in original data 
#dd3 <- data_clean3 %>%  ungroup() %>% select_if(is.numeric) %>%
#  scale %>% dist(method = "manhattan")


#rownames(data_clean3) -> attributes(dd3)$Labels

#cmds3<-cmdscale(dd3,eig = T)

#cmds3$points%>%
#as.data.frame()%>%
#rownames_to_column(var = 'Names')->df3

#df3 <- left_join(df3, data_clean3, by = c("Names" = "Name"))

#p3 <- ggplot(df3,aes(x=V1,y=V2,label=`Names`, color = DENYOther))+ geom_text(size=2) # xlim(0, 30) + ylim(-20,20)
#```