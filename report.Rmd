---
title: "High Dimensional Data Analysis - Group Assignment 18"
author: "Group 18"
date: "08/09/2021"
output: bookdown::html_document2
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(visdat)
library(splitstackshape)
library(lubridate)
bankruptcy <- read_rds(here::here("data/Bankruptcy.rds"))
```


# Overview

```{r}
glimpse(bankruptcy)
```

```{r}
vis_dat(bankruptcy)
```
Note: We can see that FirmEnd does not have any missing values, in fact it has many NULL values that is not detected. Hence, we will change it to NA. 

```{r}
bankruptcy <- bankruptcy %>%
  mutate(FirmEnd = ifelse(FirmEnd == "", 
                          NA, 
                          FirmEnd))
```

From the `glimpse` output, we also notice that `SICMajGroup`, which is the industry classification code, has a very long name, so we will separate it to the code and the meaning. 

```{r}
bankruptcy <- bankruptcy %>%
  separate(SICMajGroup, 
           into = c("SIC", "SICMajGroup"), 
           sep = "\\s", 
           extra = "merge") %>%
  mutate(SIC = as.factor(SIC))
```


Now, let us check again the missing values in data 

```{r}
vis_dat(bankruptcy)
```

**HeadCourtCityToDE**

There are some missing values in `HeadCourtCityToDE`, may be we could impute it using the values in CityFiled, DENYOther, or HeadStAtFiling. One of the row missing is Aruba, so we just google the distance between these cities an impute it (1126 miles). The other two are Canada. We search the address for the firm name and google the distance.
Loewen Group, Inc (British Columbia to Wilmington = 2942).
Philip Services Corp. (Ontario to Wilmington = 1234)


```{r}
na_distance <- bankruptcy %>%
  filter(is.na(HeadCourtCityToDE))

bankruptcy <- bankruptcy %>%
  mutate(HeadCourtCityToDE = ifelse(Name == "Divi Hotels, N.V.", 1126,
                                    ifelse(Name == "Loewen Group, Inc.", 2942,
                                           ifelse(Name == "Philip Services Corp. (1999)", 1234,
                                                  HeadCourtCityToDE))))

summary(bankruptcy$HeadCourtCityToDE)
```

The minimun distance is 1 , when inspected the state of headquarter and the city filed its in the same state, so it made sense.

**DaysIn**

Now let us move to `DaysIn` variable 

```{r}
na_daysin <- filter(bankruptcy, is.na(DaysIn))
```

Based on google search:

- [AP Industries, Inc.](https://casetext.com/case/in-re-ap-industries-inc?__cf_chl_jschl_tk__=pmd_0e9LcvX3fGC0nT5WJVBShbHDvK9GY2AMZnekCjslbN0-1631333530-0-gqNtZGzNAjujcnBszQd9) filed the bankruptcy on 27/03/1990, disposition made in 26/07/1990 equivalent to 121 days

- [Daisy Systems Corp.](https://caselaw.findlaw.com/us-9th-circuit/1020075.html) filed the bankruptcy on 30/05/1991, the court decided on 24/09/1996 equivalent to1944 days

- Since there is no data for the remaining two, we will impute the days in bankruptcy, based on firm types median. (Hunt International Resources Corp., SIC = 20; McCrory Corp., SIC = 53)

```{r}
bankruptcy %>% group_by(SIC) %>%
  summarise(median = median(DaysIn, na.rm = TRUE))
```


```{r}
bankruptcy <- bankruptcy %>%
  mutate(DaysIn = ifelse(Name == "Hunt International Resources Corp.", 305,
                                    ifelse(Name == "AP Industries, Inc.", 121,
                                           ifelse(Name == "Daisy Systems Corp.", 1944,
                                                  ifelse(Name == "McCrory Corp.", 683, DaysIn)))))

summary(bankruptcy$DaysIn)
```

There is no suspicious anomaly. The bankcruptcy process can take a long time. 

**Employees**

```{r}
na_employees <- filter(bankruptcy, is.na(Employees))
```

The number of employees of County Seat, Inc. is missing. According to [Chicago Tribune](https://www.chicagotribune.com/news/ct-xpm-1996-11-29-9611290135-story.html), the store has an average 5-10 employees and it has 740 stores. We will take 7 employees per store. So the employees before bankruptcy are approximately 5180. 

```{r}
bankruptcy <- bankruptcy %>%
  mutate(Employees = ifelse(Name == "County Seat, Inc.", 5180, Employees))

summary(bankruptcy$Employees)
```

Is it possible that companies only have 1 employees? 

```{r}
ggplot(bankruptcy, aes(x = Employees)) +
  geom_histogram()
```

```{r}
vis_dat(data)
```

**Sales**

The missing values in Sales is imputed by its median of sales grouped by SIC

```{r}
na_sales <- filter(data, is.na(Sales))

data %>%
  group_by(SIC) %>%
  summarise(median = median(Sales, na.rm = TRUE))

data <- data %>%
  mutate(Sales = ifelse(Name == "County Seat, Inc.", 1645170944, Sales))

```

**Ebit and Liab**

```{r}
na_ebit <- filter(data, is.na(Ebit))
na_liab <- filter(data, is.na(Liab))
```

Options for treat the missing values in `Liab` and `Ebit`:
1. Omit the missing values in these variables

```{r}
data_op1 <- data %>%
  filter(!is.na(Ebit) & !is.na(Liab))
```

2. Impute with its median grouped by SIC 

```{r}
data_op2 <- data %>% group_by(SIC) %>%
  mutate(Ebit = ifelse(is.na(Ebit), median(Ebit,na.rm=TRUE), Ebit))

data_op2 <- data_op2 %>% group_by(SIC) %>%
  mutate(Liab = ifelse(is.na(Liab), median(Liab,na.rm=TRUE), Liab))
```

```{r}
vis_dat(data_op2)
```
# Clean Data

Let say we use data_op1. 

```{r}
data_clean <- data_op1 %>%
  select(-FirmEnd, -EmplUnion) %>%
  mutate(DENYOther = as.factor(DENYOther),
         MonthFiled = as.factor(MonthFiled),
         YearFiled = as.factor(YearFiled))
row.names(data_clean) <- data_clean$Name
ggplot(data_clean, aes(x = Ebit)) +
  geom_histogram()
```


```{r}
vis_dat(data_clean)
```

```{r}
ggplot(data, aes(x = Employees, y = EmplUnion)) + geom_point() + geom_smooth()
```

```{r}
# data wo missing values, number obs as in original data 
dd <- data_clean %>% ungroup() %>% select_if(is.numeric) %>%
  scale %>% dist(method = "manhattan")

rownames(data_clean) -> attributes(dd)$Labels

cmds<-cmdscale(dd,eig = T)

cmds$points%>%
as.data.frame()%>%
rownames_to_column(var = 'Names')->df

p1 <- ggplot(df,aes(x=V1,y=V2,label=`Names`))+ geom_text(size=2) # xlim(0, 30) + ylim(-20,20)
```

```{r}
data_clean2 <- data_op2 %>%
  select(-FirmEnd, -EmplUnion) %>%
  mutate(DENYOther = as.factor(DENYOther),
         MonthFiled = as.factor(MonthFiled),
         YearFiled = as.factor(YearFiled)) 
row.names(data_clean2) <- data_clean2$Name

# data wo missing values, number obs as in original data 
dd2 <- data_clean2 %>%  ungroup() %>% select_if(is.numeric) %>%
  scale %>% dist(method = "manhattan")


rownames(data_clean2) -> attributes(dd2)$Labels

cmds2<-cmdscale(dd2,eig = T)

cmds2$points%>%
as.data.frame()%>%
rownames_to_column(var = 'Names')->df2

df2 <- left_join(df2, data_clean2, by = c("Names" = "Name"))

p2 <- ggplot(df2,aes(x=V1,y=V2,label=`Names`, color = DENYOther))+ geom_text(size=2) # xlim(0, 30) + ylim(-20,20)

p2
```
```{r}
library(patchwork)

p1 + p2 + plot_layout(nrow = 2)
```
```{r}
data <- read_rds(here::here("data/Bankruptcy.rds"))

data_clean3 <- data %>%
  select(-FirmEnd, -EmplUnion) %>%
  drop_na() %>%
  mutate(DENYOther = as.factor(DENYOther),
         MonthFiled = as.factor(MonthFiled),
         YearFiled = as.factor(YearFiled)) 

row.names(data_clean3) <- data_clean3$Name

# data wo missing values, number obs as in original data 
dd3 <- data_clean3 %>%  ungroup() %>% select_if(is.numeric) %>%
  scale %>% dist(method = "manhattan")


rownames(data_clean3) -> attributes(dd3)$Labels

cmds3<-cmdscale(dd3,eig = T)

cmds3$points%>%
as.data.frame()%>%
rownames_to_column(var = 'Names')->df3

df3 <- left_join(df3, data_clean3, by = c("Names" = "Name"))

p3 <- ggplot(df3,aes(x=V1,y=V2,label=`Names`, color = DENYOther))+ geom_text(size=2) # xlim(0, 30) + ylim(-20,20)
```
```{r}
p3
```
```{r}
p2
```
```{r}
p1
```

