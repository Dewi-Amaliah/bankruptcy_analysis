---
title: "High Dimensional Data Analysis - Group Assignment 18"
author: "Group 18"
date: "08/09/2021"
output:
  bookdown::html_document2:
    fig_height: 5
    fig_width: 8
    toc: yes
    toc_depth: 1
    toc_float:
      collapsed: false
    number_sections: false
    code_folding: show
    theme: readable
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE, 
                      error = FALSE)
library(tidyverse)
library(dplyr)
library(visdat)
library(splitstackshape)
library(lubridate)
library(patchwork)
library(MASS)
bankruptcy <- read_rds(here::here("data/Bankruptcy.rds"))
```


# Overview

```{r}
glimpse(bankruptcy)
```

```{r}
vis_dat(bankruptcy)
```


- Note: We can see that FirmEnd does not have any missing values, in fact it has many NULL values that is not detected. Hence, we will change it to NA. 


```{r}
bankruptcy <- bankruptcy %>%
  mutate(FirmEnd = ifelse(FirmEnd == "", 
                          NA, 
                          FirmEnd))
```

- From the `glimpse` output, we also notice that `SICMajGroup`, which is the industry classification code, has a very long name, so we will separate it to the code and the meaning. 

```{r}
bankruptcy <- bankruptcy %>%
  separate(SICMajGroup, 
           into = c("SIC", "SICMajGroup"), 
           sep = "\\s", 
           extra = "merge") %>%
  mutate(SIC = as.factor(SIC))
```


- Now, let us check again the missing values in data 

```{r}
vis_dat(bankruptcy)
```

```{r}
vis_miss(bankruptcy)
```



# Variable Discussion 

- The following variables do not need any changes
  + Name: Name of the firm
  + Assets: Total assets (in millions of dollars)
  + CityFiled: City where filing took place
  + CPI U.S CPI at the time of filing
  + DENYOther: CityFiled, categorized as Wilmington (DE), New York (NY) or all other cities (OT)
  + FilingRate: Total number of other bankrupcy filings in the year of this filing
  + GDP: Gross Domestic Product for the Quarter in which the case was filed
  + HeadCityPop: The population of the firms headquarters city
  

- Variables with a lot of missing values are:
  + FirmEnd: Short description of the event that ended the firmâ€™s existence - We plan to omit this variable for further analysis
  + EmplUnion: Number of union employees before bankruptcy - We plan to omit this variable for further analysis



- The DaysIn (Length of bankruptcy process) variable has about 0.92% missing values. In order to fill the NA's we used the following approach:


- **DaysIn**

Now let us move to `DaysIn` variable 

```{r}
na_daysin <- filter(bankruptcy, is.na(DaysIn))
na_daysin
```

Based on google search:

- [AP Industries, Inc.](https://casetext.com/case/in-re-ap-industries-inc?__cf_chl_jschl_tk__=pmd_0e9LcvX3fGC0nT5WJVBShbHDvK9GY2AMZnekCjslbN0-1631333530-0-gqNtZGzNAjujcnBszQd9) filed the bankruptcy on 27/03/1990, disposition made in 26/07/1990 equivalent to 121 days

- [Daisy Systems Corp.](https://caselaw.findlaw.com/us-9th-circuit/1020075.html) filed the bankruptcy on 30/05/1991, the court decided on 24/09/1996 equivalent to 1944 days

- Since there is no data for the remaining two, **we will impute the days in bankruptcy**, based on firm types median. (Hunt International Resources Corp., SIC = 20; McCrory Corp., SIC = 53)

```{r}
bankruptcy %>% group_by(SIC) %>%
  summarise(median = median(DaysIn, na.rm = TRUE)) %>% 
    dplyr::filter(SIC %in% c(20, 53))
```


```{r}
bankruptcy <- bankruptcy %>%
  mutate(DaysIn = ifelse(Name == "Hunt International Resources Corp.", 305,
                                    ifelse(Name == "AP Industries, Inc.", 121,
                                           ifelse(Name == "Daisy Systems Corp.", 1944,
                                                  ifelse(Name == "McCrory Corp.", 683, DaysIn)))))

summary(bankruptcy$DaysIn)
```

- There is no suspicious anomaly. The bankcruptcy process can take a long time. 


- **HeadCourtCityToDE** (The distance in miles from the firms headquarters city to the city in which the case was filed)

- There are some missing values in `HeadCourtCityToDE`, may be we could impute it using the values in CityFiled, DENYOther, or HeadStAtFiling. One of the row missing is Aruba, so we just google the distance between these cities an impute it (1126 miles). The other two are Canada. 

- We search the address for the firm name and google the distance.
Loewen Group, Inc (British Columbia to Wilmington = 2942).
Philip Services Corp. (Ontario to Wilmington = 1234)


```{r}
na_distance <- bankruptcy %>%
  filter(is.na(HeadCourtCityToDE))

na_distance

bankruptcy <- bankruptcy %>%
  mutate(HeadCourtCityToDE = ifelse(Name == "Divi Hotels, N.V.", 1126,
                                    ifelse(Name == "Loewen Group, Inc.", 2942,
                                           ifelse(Name == "Philip Services Corp. (1999)", 1234,
                                                  HeadCourtCityToDE))))

summary(bankruptcy$HeadCourtCityToDE)
```

- The minimum distance is 1 , when inspected the state of headquarter and the city filed its in the same state, so it made sense.


- **Employees** (Number of employees before bankruptcy)

```{r}
na_employees <- filter(bankruptcy, is.na(Employees))
na_employees
```

- The number of employees of County Seat, Inc. is missing. According to [Chicago Tribune](https://www.chicagotribune.com/news/ct-xpm-1996-11-29-9611290135-story.html), the store has an average 5-10 employees and it has 740 stores. We will take 7 employees per store. So the employees before bankruptcy are approximately 5180. 

```{r}
bankruptcy <- bankruptcy %>%
  mutate(Employees = ifelse(Name == "County Seat, Inc.", 5180, Employees))

summary(bankruptcy$Employees)
```

- Is it possible that companies only have 1 employees? 

```{r}
ggplot(bankruptcy, aes(x = Employees)) +
  geom_histogram()
```

- **Sales** (Sales before bankruptcy (in dollars))

- The missing values in Sales is imputed by its median of sales grouped by SIC

```{r}
na_sales <- filter(bankruptcy, is.na(Sales))
na_sales

bankruptcy %>%
  group_by(SIC) %>%
  summarise(median = median(Sales, na.rm = TRUE)) %>% 
  dplyr::filter(SIC == 56)

bankruptcy <- bankruptcy %>%
  mutate(Sales = ifelse(Name == "County Seat, Inc.", 1645170944, Sales))
```

**Ebit and Liab**

```{r}
na_ebit <- filter(bankruptcy, is.na(Ebit))
na_liab <- filter(bankruptcy, is.na(Liab))
na_ebit
na_liab
```

Options for data used in the analysis 

- 1. Omit the missing values in in `Liab` and `Ebit` after imputing missing values in `DaysIn`, `HeadCourtCityToDE`, `Sales`, and `Employees`. 


```{r}
bank_data_op1 <- bankruptcy %>%
  ungroup() %>%
  filter(!is.na(Ebit) & !is.na(Liab)) %>%
  dplyr::select(-FirmEnd, -EmplUnion) %>%
  mutate(DENYOther = as.factor(DENYOther),
         MonthFiled = as.factor(MonthFiled),
         YearFiled = as.factor(YearFiled))
row.names(bank_data_op1) <- bank_data_op1$Name
```

- 2. Impute all of the missing values including `Ebit` and `Liab`. 

```{r}
bank_data_op2 <- bankruptcy %>% group_by(SIC) %>%
  ungroup() %>%
  mutate(Ebit = ifelse(is.na(Ebit), median(Ebit,na.rm=TRUE), Ebit),
         Liab = ifelse(is.na(Liab), median(Liab,na.rm=TRUE), Liab)) %>%
  dplyr::select(-FirmEnd, -EmplUnion) %>%
  mutate(DENYOther = as.factor(DENYOther),
         MonthFiled = as.factor(MonthFiled),
         YearFiled = as.factor(YearFiled))
row.names(bank_data_op2) <- bank_data_op2$Name
```

- 3. Omit all of the missing values except `FirmEnd` and `EmplUnion` 

```{r}
bank_data_op3 <- read_rds(here::here("data/Bankruptcy.rds")) %>%
  dplyr::select(c(-FirmEnd, -EmplUnion)) %>%
  na.omit() %>%
  mutate(DENYOther = as.factor(DENYOther),
         MonthFiled = as.factor(MonthFiled),
         YearFiled = as.factor(YearFiled))
row.names(bank_data_op3) <- bank_data_op3$Name
```



# Sample MDS for diff Data Cleaning Approaches

## Use bank_data_op1

Omit the missing values in in `Liab` and `Ebit` after imputing missing values in `DaysIn`, `HeadCourtCityToDE`, `Sales`, and `Employees`. 

```{r}

dd_op1 <- bank_data_op1 %>% 
  select_if(is.numeric) %>%
  scale %>% dist()

rownames(bank_data_op1) -> attributes(dd_op1)$Labels

cmds_op1 <- cmdscale(dd_op1,eig = T)

cmds_op1$points %>%
as.data.frame() %>%
rownames_to_column(var = 'Names') -> df_op1

p1 <- ggplot(df_op1,
             aes(x=V1,
                 y=V2,
                 label=`Names`)) + 
  geom_text(size=2)

str(cmds_op1$GOF)
```


# USe bank_data_op2

Impute all of the missing values including, except missings in `FirmEnd` and `EmplUnion`.

```{r}

dd_op2 <- bank_data_op2 %>%  
  select_if(is.numeric) %>%
  scale %>% dist(method = "euclidian")
rownames(bank_data_op2) -> attributes(dd_op2)$Labels

cmds_op2 <- cmdscale(dd_op2,eig = T)

cmds_op2$points %>%
as.data.frame() %>%
rownames_to_column(var = 'Names')-> df_op2

df_op2 <- left_join(df_op2, bank_data_op2, by = c("Names" = "Name"))

p2 <- ggplot(df_op2,
             aes(x=V1,
                 y=V2,
                 label=`Names`)) + 
  geom_text(size=2)

str(cmds_op2$GOF)
```

# Data Clean Option 3

Omit all of the missing values except `FirmEnd` and `EmplUnion`

```{r}

data <- read_rds(here::here("data/Bankruptcy.rds"))

bank_data_op3 <- filter(data,Employees>=EmplUnion | is.na(EmplUnion)|is.na(Employees)) %>%
  dplyr::select(-FirmEnd, -EmplUnion) %>%
  drop_na() %>%
  mutate(DENYOther = as.factor(DENYOther),
         MonthFiled = as.factor(MonthFiled),
         YearFiled = as.factor(YearFiled)) %>%
  separate(SICMajGroup, 
           into = c("SIC", "SICMajGroup"), 
           sep = "\\s", 
           extra = "merge") %>%
  mutate(SIC = as.factor(SIC))
dd_op3 <- bank_data_op3 %>%  
  select_if(is.numeric) %>%
  scale %>% dist

rownames(bank_data_op3) -> attributes(dd_op3)$Labels

cmds_op3 <- cmdscale(dd_op3,eig = T)

cmds_op3$points %>%
as.data.frame() %>%
rownames_to_column(var = 'Names')-> df_op3

df_op3 <- left_join(df_op3, bank_data_op3, by = c("Names" = "Name"))

p3 <- ggplot(df_op3,
             aes(x=V1,
                 y=V2,
                 label=`Names`)) + 
  geom_text(size=2) 

str(cmds_op3$GOF)
```

# Plots

```{r}
p1
```

```{r}
p2
```

```{r}
p3
```


# Ruben's Consultation Questions

- We plan to omit EmplUnion in further analysis, due to 30 percent missing values - ?

```{r}
ggplot(bankruptcy, aes(x = Employees, y = EmplUnion)) + geom_point() + geom_smooth()
```

- Omit all Ebit (Earnings (operating income) at time of filing (in millions of dollars)) and Liab (Total amount of money owed (in millions of dollars)) mising values or Impute - ?

- In the employee summary statistic we have one employee is it ppossible to have one emp - ?


```{r}
smds_op1<-sammon(dd_op1)
k_op1 <- isoMDS(dd_op1)

smds_op1$stress
```


```{r}
smds_op2<-sammon(dd_op2)
k_op2 <- isoMDS(dd_op2)
smds_op2$stress
```

```{r}
smds_op3<-sammon(dd_op3)
k_op3 <- isoMDS(dd_op3)
smds_op3$stress
```

NOTE: We use bank_op_1 in MDS because it has the best performance in Non-Classical MDS. Not the est in classical (but it is near the the biggest GOF)