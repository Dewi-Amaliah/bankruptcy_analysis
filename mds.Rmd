---
title: "MDS"
author: "Group 18"
date: "17/09/2021"
output: html_document
---

```{r setup_mds, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(dplyr)
library(visdat)
library(splitstackshape)
library(lubridate)
library(patchwork)
library(MASS)
library(mclust)
library(forcats)
bankruptcy <- read_rds(here::here("data/Bankruptcy.rds"))
```

```{r}
bankruptcy <- bankruptcy %>%
  mutate(FirmEnd = ifelse(FirmEnd == "",
                          NA,
                          FirmEnd))

bankruptcy <- bankruptcy %>%
  separate(SICMajGroup,
           into = c("SIC", "SICMajGroup"),
           sep = "\\s",
           extra = "merge") %>%
  mutate(SIC = as.factor(SIC))

# get the median of DaysIn 
bankruptcy %>% group_by(SIC) %>%
  summarise(median = median(DaysIn, na.rm = TRUE)) %>% 
    dplyr::filter(SIC %in% c(20, 53))

# actual value of AP Industries and Daisy System Corp can be found in the internet
# Hunt International and McCrory use the median imputation 
bankruptcy <- bankruptcy %>%
  mutate(DaysIn = ifelse(Name == "Hunt International Resources Corp.", 305,
                                    ifelse(Name == "AP Industries, Inc.", 121,
                                           ifelse(Name == "Daisy Systems Corp.", 1944,
                                                  ifelse(Name == "McCrory Corp.", 683, DaysIn)))))
# bankruptcy <- bankruptcy %>%
#   mutate(DaysIn = ifelse(Name == "AP Industries, Inc.", 121,
#                                            ifelse(Name == "Daisy Systems Corp.", 1944, DaysIn)))

# search the address of Divi Hotels, Loewen, and Philip, google the distance between them 
# hence imputation using all the actual values
bankruptcy <- bankruptcy %>%
  mutate(HeadCourtCityToDE = ifelse(Name == "Divi Hotels, N.V.", 1126,
                                    ifelse(Name == "Loewen Group, Inc.", 2942,
                                           ifelse(Name == "Philip Services Corp. (1999)", 1234,                                HeadCourtCityToDE))))

# google search result
bankruptcy <- bankruptcy %>%
  mutate(Employees = ifelse(Name == "County Seat, Inc.", 5180, Employees))

# omit NA in Liab and Ebit 
bank_data_op1 <- bankruptcy %>%
  filter(!is.na(Ebit) & !is.na(Liab)) %>%
  filter(Name != "Promus Companies Inc. (Harrahs Jazz Co. only)")


data_clean <- bank_data_op1 %>%
  dplyr::select(-FirmEnd, -EmplUnion) %>%
  mutate(DENYOther = as.factor(DENYOther),
         MonthFiled = as.factor(MonthFiled),
         YearFiled = as.factor(YearFiled))

#row.names(clean_data) <- clean_data$Name
```

## Multidimensional Scaling (MDS)

MDS is a statistical method to represent multidimensional data into lower-dimensional (2D) data. The `bankruptcy` data has 21 variables which can be considered as data with high dimensions. Thus, MDS is relevant to represent this data in two-dimensional visualisation. This method uses distance to do the job. Hence, we limit the MDS only to incorporate numerical variables so that we can use Euclidean distance or is known as classical MDS. Moreover, as in the preliminary data analysis shown in the previous section, we will only incorporate numerical variables directly related to bankruptcy. Those variables are: `Assest`, `DaysIn`, `Employees`, `CPI`, `Ebit`, `Liab`, `FillingRate`, `GDP`, `PrimeFilling`, and `Sales`. We also know that these variables have different unit measurements. For example, liability is measured in a million $US dollar, while sales are measured in $US dollar. Hence, we will standardise the variable prior to conducting the MDS.     

**Classical MDS**

```{r}
dd <- data_clean %>% 
  dplyr::select(c(Assets, DaysIn, Employees, CPI, Ebit, Liab, FilingRate, GDP, PrimeFiling, Sales)) %>%
  #select_if(is.numeric) %>%
  scale %>% dist()

#rownames(clean_data) -> attributes(dd)$Labels


cmds <- cmdscale(dd,eig = T)

df <- cmds$points %>%
  as.data.frame()

df_join <- cbind(df, data_clean) %>%
  mutate(Names = abbreviate(Name)) 
```


```{r cmds-plot, fig.cap="Classical MDS solution for bankruptcy data. The x and y-axis represent the new variables as the result of MDS. Some outliers observed in thedata"}
ggplot(df_join,
             aes(x=V1,
                 y=V2,
                 label= Names)) + 
  geom_text(size=2) +
  theme_bw()
```

Figure \ref{fig:cmds-plot} conveys the lower-dimensional representation of bankruptcy data using classical MDS. Texaco Inc (Tin.), Baldwin-United Corporation (B-UC), Federated Department Stores, Inc. (FDSI), LTV Corp. (1986) (LTCV.(1) are potential outliers. On closer inspection of the data, we find that these companies have the largest assets. Moreover, Texaco Inc. also has high operating income, sales, and liability.  

As mentioned previously, the aim of MDS is to visualise the companies in 2D scatter plot. However, this objective will be less clearly achieved in  \ref{fig:cmds-plot} since too many observations overlapped each other. Hence, we decided to exclude Texaco Inc. and re-conduct classical MDS. This give us clearer visualisation as follows:


```{r}
exclude_texaco <- data_clean %>%
  filter(Name != "Texaco Inc.")

dd_excl <- exclude_texaco %>% 
  dplyr::select(c(Assets, DaysIn, Employees, CPI, Ebit, Liab, FilingRate, GDP, PrimeFiling, Sales)) %>%
  #select_if(is.numeric) %>%
  scale %>% dist()

#rownames(clean_data) -> attributes(dd)$Labels


cmds_excl <- cmdscale(dd_excl,eig = T)

df_excl <- cmds_excl$points %>%
  as.data.frame()

df_join_excl <- cbind(df_excl, exclude_texaco) %>%
  mutate(Names = abbreviate(Name)) %>%
  mutate(SIC_collaps = fct_collapse(SICMajGroup, `Crops` = "Crops",
                                    `Mining, Oil & Gas Extraction` = c("Metal Mining", "Coal Mining",
                                                                       "Oil And Gas Extraction"),
                                    `Construction` = c("Building Construction General Contractors And Operative Builders",
                                                       "Heavy Construction Other Than Building Construction Contractors",
                                                       "Construction Special Trade Contractors"),
                                    `Manufacture` = c("Food and Kindred Products",
                                                      "Textile Mill Products",
                                                      "Apparel And Other Finished Products Made From Fabrics And Similar Materi",
                                                      "Lumber And Wood Products, Except Furniture",
                                                      "Furniture And Fixtures",
                                                      "Paper and Allied Products",
                                                      "Printing, Publishing, And Allied Industries",
                                                      "Chemicals and Allied Products",
                                                      "Petroleum Refining And Related Industries",
                                                      "Rubber and Miscellaneous Plastics Products",
                                                      "Stone, Clay, Glass, And Concrete Products",
                                                      "Primary Metal Industries",
                                                      "Fabricated Metal Products, Except Machinery and Transportation Equipment",
                                                      "Industrial and Commercial Machinery and Computer Equipment",
                                                      "Electronic And Other Electrical Equipment And Components",
                                                      "Transportation Equipment",
                                                      "Measuring, Analyzing and Controlling Instruments; Photographic, Medical",
                                                      "Miscellaneous Manufacturing Industries"),
                                    `Transportation & Warehouse` = c("Local And Suburban Transit And Interurban Highway Passenger Transportati",
                                                                     "Motor Freight Transportation And Warehousing",
                                                                     "Water Transportation",
                                                                     "Transportation By Air"),
                                    `Communications` = "Communications",
                                    `Services` = c("Electric, Gas, And Sanitary Services",
                                                   "Personal Services",
                                                   "Business Services",
                                                   "Automotive Repair, Services, and Parking",
                                                   "Miscellaneous Repair Services",
                                                   "Motion Pictures",
                                                   "Amusement And Recreation Services",
                                                   "Health Services",
                                                   "Social Services",
                                                   "Engineering, Accounting, Research, Management, and Related Services"),
                                    `Wholesale & Retail` = c("Wholesale Trade-durable Goods",
                                                             "Wholesale Trade-non-durable Goods",
                                                             "Building Materials, Hardware, Garden Supply, And Mobile Home Dealers",
                                                             "General Merchandise Stores",
                                                             "Food Stores",
                                                             "Apparel And Accessory Stores",
                                                             "Home Furniture, Furnishings, and Equipment Stores",
                                                             "Eating and Drinking Places",
                                                             "Miscellaneous Retail"),
                                    `Finance` = c("Depository Institutions",
                                                  "Non-depository Credit Institutions",
                                                  "Insurance Carriers"),
                                    `Real Estate` = c("Real Estate",
                                                      "Holding And Other Investment Offices",
                                                      "Hotels, Rooming Houses, Camps, and Other Lodging Places")))
```


```{r cmds-plot-excl, fig.cap="Classical MDS solution for bankruptcy data after excluding Texaco Inc. The x and y-axis represent the new variables as the result of MDS. We get a clearer visualisation compared to the previous MDS result"}
ggplot(df_join_excl,
             aes(x=V1,
                 y=V2,
                 label= Names)) + 
  geom_text(size=2) +
  theme_bw()
```

Figure \ref{cmds-plot-excl} suggests that the visual representation of the rest companies other than Texaco, Inc. remains the same. B-UC, LTCV.(1, and FDSI are still far apart from other companies. Some companies It implies that our MDS is pretty robust. However, since it gives a clearer visualisation, we will use the data without Texaco, Inc. in the rest of MDS analysis.  

Figure \ref{cmds-plot-excl} also implies that most companies that filed for bankruptcy has similar characteristic since it tend to plotted near even overlapped each other. We can also say, for example, that First Capital Holdings Corp. (FCHC) and Southland Corp. (SthlCrp.) are similar in which the companies filed for bankruptcy in the pretty similar situasion of macroeconomic performance (GDP and CPI). 


**Goodness of Fit**

The objective of classical MDS is to minimise the strain. This aim could be achieved when Euclidean distance is used and thus all eigenvalues are positive. It is also worth to inspect the Goodness of Fit (GoF) of the solution. If two GoF values are equal, then we can conclude that the MDS solution is optimal. 

The following is the GoF values of the classical MDS:

```{r}
str(cmds_excl$GOF)
```

The two GoF values are equal, which is the case if we are using Eucledean distance. These values also infer that our classical MDS solution is optimal. Moreover, when we inspected the eigenvalues result, we found the following: 

```{r}
min(cmds_excl$eig)
```

Since the values has e-12, it is reciprocal to 2 with 12 trailing zeros. Hence, even though it looks negative, it is very close, even indistinguishable from zero.  That is why the value of $GoF_1$ and $GoF_2$ are equal. 

**Comparison with non-Classical MDS**

Next, we compare the classical MDS with non-classical MDS. One of non-classical MDS methods is Sammon mapping which use numerical optimisation. The stress function could be used to indicate the accuracy of representation. The lower, the better the accuracy. The strees value of Sammon mapping is displayes as follows:

```{r}
smds<-sammon(dd_excl)
smds$stress
```

This values is relatively low, so we can say that the non-classical MDS also produce fairly accurate representation of the bankruptcy data. Moreover, the plot (included in Appendix) also produce relatively similar result when compared with the classical MDS. Hence, we can conclude that the result is fairly robust with the change of methodology. 

**Visualisation with Categorical Variable**

As mentioned previously, we only use numerical data in the analysis to allow us calculate Eucledean distance and perform classical MDS. Hence, to also take the categorical variables into account, we display plots based on some categorical features in the data.

Figure \ref{cmds-industry} shows the classical MDS solution by industry classification. Note that in the original data, there are 55 industry. This number is to big to be plotted, hence we collapse some industry which has the similar sector, for example manufacture, mining, construction, and finance. 

```{r cmds-industry, fig.cap = "Classical MDS solution plotted by industry."}
ggplot(df_join_excl,
             aes(x=V1,
                 y=V2,
                 label= Names,
                 color = SIC_collaps)) + 
  geom_text(size=3) +
  theme_bw() +
  theme(legend.position = "bottom") +
  guides(color=guide_legend(title="Industry")) +
  scale_colour_manual(values = c("red", "#884EA0", "#3498DB", "#16A085", "#F1C40F",
                                 "#2ECC71", "#EB984E", "pink", "magenta", "black"))
```

Figure \ref{cmds-industry} suggests that there is no clear specific pattern of the company bankruptcy regarding the industry. Wholesale and retail companies is bit more spread out. Manufacture industry is also observed to be spread out everywhere and could be because this industry has many observations. Further, B-UC and SthmCrp. are observed to be relatively further apart from the other real estate company since they have bigger assets. 


```{r cmds-city, fig.cap = "Classical MDS solution plotted by city where the bankruptcy filed."}
ggplot(df_join_excl,
             aes(x=V1,
                 y=V2,
                 label= Names,
                 color = DENYOther)) + 
  geom_text(size=3) +
  theme_bw() +
  theme(legend.position = "bottom") +
  guides(color=guide_legend(title="City"))
```

Figure \ref{cmds-city} shows no specific pattern of bankruptcy regarding the city where it is filed. The companies who similar to each other (as seen in the overlapped text) could filed for bankruptcy in different city. Besides, companies who are potentially outliers (B-UC, LTCV.(1, and FDSI) are not filed their bankruptcy in Delaware. 

```{r cmds-year, fig.cap = "Classical MDS solution plotted by year when the bankruptcy filed."}
ggplot(df_join_excl,
             aes(x=V1,
                 y=V2,
                 label= Names,
                 color = YearFiled)) + 
  geom_text(size=3) +
  theme_bw() +
  theme(legend.position = "bottom")
```

The classical MDS solution plotted by year as shown in Figure \ref{fig:cmds-year} shows that there is pattern regarding the year. Companies who filed for bankruptcy in the same year tend to be similar each other. This could be because in the same year, CPI, filing rate, and prime interest are pretty similar. This is an interesting finding since we could infer that macroeconomic ,i.e, market condition could profile companies who filed for bankruptcy. 


## Limitations 

- We only use numerical data in the analysis due to the complexity of incorporating non-numeric data. However, we tried to also display that categorical variable when visualising the MDS result. 
- Interpreting plots with too many categories in legend is hard. We tried to tackle this by collapsing categories but we find that it still hard. Hence, interactive plot with ability to hover the company would be better. 


## Appendix

MDS plot using Sammon mapping.

```{r sammon-plot, fig.cap="MDS solution using Sammon mapping"}
df_join_excl <-add_column(df_join_excl,Sammon1=smds$points[,1],
                     Sammon2=smds$points[,2])

ggplot(df_join_excl,aes(x=Sammon1,y=Sammon2, label=`Names`))+ geom_text(size=2) +
  theme_bw()
```

