---
title: "Assignment 2 Report"
author: Aarathy Babu, Dewi Amaliah, Priya Dingorkar, Rahul Bharadwaj
output: bookdown::pdf_document2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(dplyr)
library(visdat)
library(splitstackshape)
library(lubridate)
library(patchwork)
library(MASS)

bankruptcy <- read_rds(here::here("data/Bankruptcy.rds"))
```

# Introduction

# Preliminary Analysis

# Multidimensional Scaling (MDS)


```{r}
bankruptcy <- bankruptcy %>%
  mutate(FirmEnd = ifelse(FirmEnd == "",
                          NA,
                          FirmEnd))

bankruptcy <- bankruptcy %>%
  separate(SICMajGroup,
           into = c("SIC", "SICMajGroup"),
           sep = "\\s",
           extra = "merge") %>%
  mutate(SIC = as.factor(SIC))

# get the median of DaysIn 
bankruptcy %>% group_by(SIC) %>%
  summarise(median = median(DaysIn, na.rm = TRUE)) %>% 
    dplyr::filter(SIC %in% c(20, 53))

# actual value of AP Industries and Daisy System Corp can be found in the internet
# Hunt International and McCrory use the median imputation 
bankruptcy <- bankruptcy %>%
  mutate(DaysIn = ifelse(Name == "Hunt International Resources Corp.", 305,
                                    ifelse(Name == "AP Industries, Inc.", 121,
                                           ifelse(Name == "Daisy Systems Corp.", 1944,
                                                  ifelse(Name == "McCrory Corp.", 683, DaysIn)))))
# bankruptcy <- bankruptcy %>%
#   mutate(DaysIn = ifelse(Name == "AP Industries, Inc.", 121,
#                                            ifelse(Name == "Daisy Systems Corp.", 1944, DaysIn)))

# search the address of Divi Hotels, Loewen, and Philip, google the distance between them 
# hence imputation using all the actual values
bankruptcy <- bankruptcy %>%
  mutate(HeadCourtCityToDE = ifelse(Name == "Divi Hotels, N.V.", 1126,
                                    ifelse(Name == "Loewen Group, Inc.", 2942,
                                           ifelse(Name == "Philip Services Corp. (1999)", 1234,                                HeadCourtCityToDE))))

# google search result
bankruptcy <- bankruptcy %>%
  mutate(Employees = ifelse(Name == "County Seat, Inc.", 5180, Employees))

# omit NA in Liab and Ebit 
bank_data_op1 <- bankruptcy %>%
  filter(!is.na(Ebit) & !is.na(Liab)) %>%
  filter(Name != "Promus firms Inc. (Harrahs Jazz Co. only)")


data_clean <- bank_data_op1 %>%
  dplyr::select(-FirmEnd, -EmplUnion) %>%
  mutate(DENYOther = as.factor(DENYOther),
         MonthFiled = as.factor(MonthFiled),
         YearFiled = as.factor(YearFiled))

#row.names(clean_data) <- clean_data$Name
```

## Multidimensional Scaling (MDS)

MDS is a statistical method to represent multidimensional data into lower-dimensional (2D) data. The `bankruptcy` data has 21 variables which can be considered as data with high dimensions. Thus, MDS is relevant to represent this data in two-dimensional visualisation. This method uses distance to do the job. Hence, we limit the MDS only to incorporate numerical variables so that we can use Euclidean distance or is known as classical MDS. We will also only incorporate numerical variables directly related to bankruptcy. Those variables are: `Assest`, `DaysIn`, `Employees`, `CPI`, `Ebit`, `Liab`, `FillingRate`, `GDP`, `PrimeFilling`, and `Sales`. These variables has different unit of measurements, hence we standardise it.

### Classical MDS

```{r}
dd <- data_clean %>% 
  dplyr::select(c(Assets, DaysIn, Employees, CPI, Ebit, Liab, FilingRate, GDP, PrimeFiling, Sales)) %>%
  #select_if(is.numeric) %>%
  scale %>% dist()

#rownames(clean_data) -> attributes(dd)$Labels


cmds <- cmdscale(dd,eig = T)

df <- cmds$points %>%
  as.data.frame()

df_join <- cbind(df, data_clean) %>%
  mutate(Names = abbreviate(Name)) 
```


```{r cmds-plot, fig.cap="Classical MDS solution for bankruptcy data. The x and y-axis represent the new variables as the result of MDS. Some outliers observed in thedata"}
ggplot(df_join,
             aes(x=V1,
                 y=V2,
                 label= Names)) + 
  geom_text(size=2) +
  theme_bw()
```

Figure \@ref(fig:cmds-plot) conveys that Texaco Inc (Tin.), Baldwin-United Corporation (B-UC), Federated Department Stores, Inc. (FDSI), LTV Corp. (1986) (LTCV.(1) are potential outliers. On closer inspection of the data, we find that these firms have the largest assets. Moreover, Texaco Inc. also has high operating income, sales, and liability.  

As mentioned previously, the aim of MDS is to visualise the firms in 2D scatter plot. However, this objective will be less clearly achieved in Figure \@ref(fig:cmds-plot) since too many observations overlapped each other. Hence, we decide to exclude Texaco Inc. and re-conduct classical MDS. This gives us a clearer visualisation as follows:


```{r}
exclude_texaco <- data_clean %>%
  filter(Name != "Texaco Inc.")

dd_excl <- exclude_texaco %>% 
  dplyr::select(c(Assets, DaysIn, Employees, CPI, Ebit, Liab, FilingRate, GDP, PrimeFiling, Sales)) %>%
  #select_if(is.numeric) %>%
  scale %>% dist()

#rownames(clean_data) -> attributes(dd)$Labels


cmds_excl <- cmdscale(dd_excl,eig = T)

df_excl <- cmds_excl$points %>%
  as.data.frame()

df_join_excl <- cbind(df_excl, exclude_texaco) %>%
  mutate(Names = abbreviate(Name)) %>%
  mutate(SIC_collaps = fct_collapse(SICMajGroup, `Crops` = "Crops",
                                    `Mining, Oil & Gas Extraction` = c("Metal Mining", "Coal Mining",
                                                                       "Oil And Gas Extraction"),
                                    `Construction` = c("Building Construction General Contractors And Operative Builders",
                                                       "Heavy Construction Other Than Building Construction Contractors",
                                                       "Construction Special Trade Contractors"),
                                    `Manufacture` = c("Food and Kindred Products",
                                                      "Textile Mill Products",
                                                      "Apparel And Other Finished Products Made From Fabrics And Similar Materi",
                                                      "Lumber And Wood Products, Except Furniture",
                                                      "Furniture And Fixtures",
                                                      "Paper and Allied Products",
                                                      "Printing, Publishing, And Allied Industries",
                                                      "Chemicals and Allied Products",
                                                      "Petroleum Refining And Related Industries",
                                                      "Rubber and Miscellaneous Plastics Products",
                                                      "Stone, Clay, Glass, And Concrete Products",
                                                      "Primary Metal Industries",
                                                      "Fabricated Metal Products, Except Machinery and Transportation Equipment",
                                                      "Industrial and Commercial Machinery and Computer Equipment",
                                                      "Electronic And Other Electrical Equipment And Components",
                                                      "Transportation Equipment",
                                                      "Measuring, Analyzing and Controlling Instruments; Photographic, Medical",
                                                      "Miscellaneous Manufacturing Industries"),
                                    `Transportation & Warehouse` = c("Local And Suburban Transit And Interurban Highway Passenger Transportati",
                                                                     "Motor Freight Transportation And Warehousing",
                                                                     "Water Transportation",
                                                                     "Transportation By Air"),
                                    `Communications` = "Communications",
                                    `Services` = c("Electric, Gas, And Sanitary Services",
                                                   "Personal Services",
                                                   "Business Services",
                                                   "Automotive Repair, Services, and Parking",
                                                   "Miscellaneous Repair Services",
                                                   "Motion Pictures",
                                                   "Amusement And Recreation Services",
                                                   "Health Services",
                                                   "Social Services",
                                                   "Engineering, Accounting, Research, Management, and Related Services"),
                                    `Wholesale & Retail` = c("Wholesale Trade-durable Goods",
                                                             "Wholesale Trade-non-durable Goods",
                                                             "Building Materials, Hardware, Garden Supply, And Mobile Home Dealers",
                                                             "General Merchandise Stores",
                                                             "Food Stores",
                                                             "Apparel And Accessory Stores",
                                                             "Home Furniture, Furnishings, and Equipment Stores",
                                                             "Eating and Drinking Places",
                                                             "Miscellaneous Retail"),
                                    `Finance` = c("Depository Institutions",
                                                  "Non-depository Credit Institutions",
                                                  "Insurance Carriers"),
                                    `Real Estate` = c("Real Estate",
                                                      "Holding And Other Investment Offices",
                                                      "Hotels, Rooming Houses, Camps, and Other Lodging Places")))
```


```{r cmds-plot-excl, fig.cap="Classical MDS solution for bankruptcy data after excluding Texaco Inc. The x and y-axis represent the new variables as the result of MDS. We get a clearer visualisation compared to the previous MDS result"}
ggplot(df_join_excl,
             aes(x=V1,
                 y=V2,
                 label= Names)) + 
  geom_text(size=2) +
  theme_bw()
```


Figure \@ref(fig:cmds-plot-excl) suggests that the visual representation of the rest firms other than Texaco, Inc. remains the same. B-UC, LTCV.(1, and FDSI are still far apart from other firms. It implies that our MDS is pretty robust. However, since it gives a clearer visualisation, we will use the data without Texaco, Inc. in the rest of MDS analysis. It also implies that most firms that filed for bankruptcy have similar characteristics since they tend to be plotted near or even overlapped with each other. We can also see that some firms are spread out. It means that these firms have different profile. 

## Goodness of Fit

In this part, we inspect the MDSâ€™s Goodness of Fit. If two GoF values are equal, which is the ideal condition if we use Eucledean distance, then we can conclude that the strain is minimised and the solution is optimal. Here is the GoFs of the MDS:

```{r}
str(cmds_excl$GOF)
```

We find that the $GoF_1$ and $GoF_2$ are equal. Hence, our MDS is optimal. We also find that all the eigenvalues are positive (see Appendix). 

### Comparison with non-Classical MDS

Next, we compare the classical MDS with non-classical MDS (Sammon mapping). The stress function could be used to indicate the accuracy of representation. The lower, the better the accuracy. 

```{r}
smds<-sammon(dd_excl)
smds$stress
```


We find that the stress is relatively low (0.121), thus non-classical MDS also produce fairly accurate representation of the bankruptcy data. Moreover, the plot (see Appendix) also produce relatively similar result when compared with the classical MDS. Hence, we can conclude that the result is fairly robust with the change of methodology. 

### Visualisation with Categorical Variable

This section will show the MDS solution by also take the categorical variables into account. Too keep the report concise, we displaye some categorical features in the Appendix and only display interesting finding in this subsection. 

```{r cmds-year, fig.cap = "Classical MDS solution plotted by year when the bankruptcy filed."}
ggplot(df_join_excl,
             aes(x=V1,
                 y=V2,
                 label= Names,
                 color = YearFiled)) + 
  geom_text(size=3) +
  theme_bw() +
  theme(legend.position = "bottom")
```

The classical MDS solution plotted by year as shown in Figure \@ref(fig:cmds-year) shows that there is pattern regarding the year. Firms who filed for bankruptcy in the same year tend to be similar each other. This could be because in the same year, CPI, filing rate, and prime interest are pretty similar. This is an interesting finding since we could infer that macroeconomic ,i.e, market condition could profile firms who filed for bankruptcy. 


# Principal Component Analysis (PCA)

# Cluster Analysis

# Limitations

- We only use numerical data in the analysis due to the complexity of incorporating non-numeric data. However, we tried to also display that categorical variable when visualising the MDS result. 

# Conclusions

# Appendix

**Eigenvalues of classical MDS**

```{r}
min(cmds_excl$eig)
```

Since the values has e-12, it is reciprocal to 2 with 12 trailing zeros. Hence, even though it looks negative, it is very close, even indistinguishable from zero.  That is why the value of $GoF_1$ and $GoF_2$ are equal. 

**MDS plot using Sammon mapping**

```{r sammon-plot, fig.cap="MDS solution using Sammon mapping"}
df_join_excl <-add_column(df_join_excl,Sammon1=smds$points[,1],
                     Sammon2=smds$points[,2])

ggplot(df_join_excl,aes(x=Sammon1,y=Sammon2, label=`Names`))+ geom_text(size=2) +
  theme_bw()
```

**Additional plots of MDS based on the city where the bankruptcy filed**

```{r cmds-city, fig.cap = "Classical MDS solution plotted by city where the bankruptcy filed."}
ggplot(df_join_excl,
             aes(x=V1,
                 y=V2,
                 label= Names,
                 color = DENYOther)) + 
  geom_text(size=3) +
  theme_bw() +
  theme(legend.position = "bottom") +
  guides(color=guide_legend(title="City"))
```

Figure \@ref(fig:cmds-city) shows no specific pattern of bankruptcy regarding the city where it is filed. The firms who similar to each other (as seen in the overlapped text) could filed for bankruptcy in different city. Besides, firms who are potentially outliers (B-UC, LTCV.(1, and FDSI) are not filed their bankruptcy in Delaware. 

**Additional plots of MDS based on industry**

Figure \@ref(fig:cmds-industry) shows the classical MDS solution by industry classification. Note that in the original data, there are 55 industry. This number is too big to be plotted, hence we collapse some industry which has the similar sector, for example manufacture, mining, construction, and finance. 

```{r cmds-industry, fig.cap = "Classical MDS solution plotted by industry."}
ggplot(df_join_excl,
             aes(x=V1,
                 y=V2,
                 label= Names,
                 color = SIC_collaps)) + 
  geom_text(size=3) +
  theme_bw() +
  theme(legend.position = "bottom") +
  guides(color=guide_legend(title="Industry")) +
  scale_colour_manual(values = c("red", "#884EA0", "#3498DB", "#16A085", "#F1C40F",
                                 "#2ECC71", "#EB984E", "pink", "magenta", "black"))
```

Figure \@ref(fig:cmds-industry) suggests that there is no clear specific pattern of the firm bankruptcy regarding the industry. Wholesale and retail firms is bit more spread out. Manufacture industry is also observed to be spread out everywhere and could be because this industry has many observations. Further, B-UC and SthmCrp. are observed to be relatively further apart from the other real estate firms since they have bigger assets. 